<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-08-10">
<meta name="description" content="This is a practice notebook using the fastai library to build a simple image classifier for cricket, tennis, basketball, and soccer.">

<title>Random Thoughts - Train an Image Classifier using Fastai (Deep Dive Analysis)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-20316028', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Random Thoughts - Train an Image Classifier using Fastai (Deep Dive Analysis)">
<meta property="og:description" content="This is a practice notebook using the fastai library to build a simple image classifier for cricket, tennis, basketball, and soccer.">
<meta property="og:image" content="images/2022-08-10-sagemaker-fastai-classifier.jpeg">
<meta property="og:site-name" content="Random Thoughts">
<meta name="twitter:title" content="Random Thoughts - Train an Image Classifier using Fastai (Deep Dive Analysis)">
<meta name="twitter:description" content="This is a practice notebook using the fastai library to build a simple image classifier for cricket, tennis, basketball, and soccer.">
<meta name="twitter:image" content="images/2022-08-10-sagemaker-fastai-classifier.jpeg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Random Thoughts</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hassaanbinaslam/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hassaanbinaslam/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hassaanbinaslam"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#environment" id="toc-environment" class="nav-link" data-scroll-target="#environment">Environment</a></li>
  <li><a href="#fastai-setup" id="toc-fastai-setup" class="nav-link" data-scroll-target="#fastai-setup">Fastai setup</a></li>
  <li><a href="#prepare-data-set" id="toc-prepare-data-set" class="nav-link" data-scroll-target="#prepare-data-set">Prepare data set</a></li>
  <li><a href="#create-a-data-block" id="toc-create-a-data-block" class="nav-link" data-scroll-target="#create-a-data-block">Create a data block</a></li>
  <li><a href="#create-a-data-loader-and-show-batch" id="toc-create-a-data-loader-and-show-batch" class="nav-link" data-scroll-target="#create-a-data-loader-and-show-batch">Create a data loader and show batch</a></li>
  <li><a href="#train-an-image-classifier" id="toc-train-an-image-classifier" class="nav-link" data-scroll-target="#train-an-image-classifier">Train an image classifier</a></li>
  <li><a href="#interpret-the-trained-model" id="toc-interpret-the-trained-model" class="nav-link" data-scroll-target="#interpret-the-trained-model">Interpret the trained model</a></li>
  <li><a href="#export-and-load-a-trained-model" id="toc-export-and-load-a-trained-model" class="nav-link" data-scroll-target="#export-and-load-a-trained-model">Export and load a trained model</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Train an Image Classifier using Fastai (Deep Dive Analysis)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">aws</div>
    <div class="quarto-category">ml</div>
    <div class="quarto-category">sagemaker</div>
    <div class="quarto-category">fastai</div>
  </div>
  </div>

<div>
  <div class="description">
    This is a practice notebook using the fastai library to build a simple image classifier for cricket, tennis, basketball, and soccer.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 10, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><img src="images/2022-08-10-sagemaker-fastai-classifier.jpeg" class="img-fluid"></p>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this notebook, we will build an image classifier to categorize images for different types of balls, including cricket, tennis, basketball, and soccer. Data is collected from the <a href="https://duckduckgo.com/">DuckDuckGo</a> search engine. Unlike a getting started tutorial, we will take an alternate approach. Our focus is NOT to quickly train a model/prototype with <a href="https://docs.fast.ai/">fastai</a> library. It may take only 5 lines of code to prepare an image classifier using this library. Instead, let’s aim to understand each line and function involved in the process. We have a lot to uncover, so let’s get started.</p>
</section>
<section id="environment" class="level1">
<h1>Environment</h1>
<p>This notebook is prepared using Amazon SageMaker studio’s <code>Python 3 (PyTorch 1.10 Python 3.8 GPU Optimized)</code> kernel running on the <code>ml.t3.medium</code> instance. I have also tried other images, including <code>Data Science</code> and <code>Data Science 2.0</code>, but fastai does not work smoothly with them. <code>ml.t3.medium</code> does not have any GPU attached to it but somehow <code>Python 3 (PyTorch 1.10 Python 3.8 CPU Optimized)</code> kernel was giving slow performance compare to GPU optimized.</p>
<p>You may run this notebook on any other system without any issue.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>aws <span class="op">--</span>version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>aws-cli/1.22.68 Python/3.8.10 Linux/4.14.287-215.504.amzn2.x86_64 botocore/1.24.13</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>python3 <span class="op">--</span>version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Python 3.8.10</code></pre>
</div>
</div>
</section>
<section id="fastai-setup" class="level1">
<h1>Fastai setup</h1>
<p>Intall fastai library. I have used IPython magic cell <code>%%capture</code> to capture and discard output of this cell. You may read more about this magic command from <a href="https://notebook.community/lifeinoppo/littlefishlet-scode/RES/REF/python_sourcecode/ipython-master/examples/IPython%20Kernel/Capturing%20Output">Capturing Output With %%capture</a></p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>U fastai</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, I will install the library “duckduckgo_search” that can be used to “Search for words, documents, images, news, maps and text translation using the DuckDuckGo.com search engine.”</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>Uqq duckduckgo_search</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Checking the version of the installed fastai library.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastai</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>fastai.__version__</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>'2.7.9'</code></pre>
</div>
</div>
</section>
<section id="prepare-data-set" class="level1">
<h1>Prepare data set</h1>
<p>We will download training data images from <a href="https://duckduckgo.com/">DuckDuckGo search engine</a>. The following function uses the search engine to “query” for an image and returns searched image URLs.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Define a function to search images and return URLs</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use 'duckduckgo' search engine to find image URLs</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> duckduckgo_search <span class="im">import</span> ddg_images</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search_images(term, max_images<span class="op">=</span><span class="dv">200</span>):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Searching for '</span><span class="sc">{</span>term<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> L(ddg_images(term, max_results<span class="op">=</span>max_images)).itemgot(<span class="st">'image'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s define the search strings to download images for tennis, cricket, soccer, and basketball balls.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Define the search strings to find images on the Internet</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>searches <span class="op">=</span> {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tennis"</span>: <span class="st">"tennis ball photo"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cricket"</span>: <span class="st">"cricket hard ball photo"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"soccer"</span>: <span class="st">"soccer ball photo"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"basketball"</span>: <span class="st">"basketball ball photos"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>searches</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>{'tennis': 'tennis ball photo',
 'cricket': 'cricket hard ball photo',
 'soccer': 'soccer ball photo',
 'basketball': 'basketball ball photos'}</code></pre>
</div>
</div>
<p>Search and get the URL for a tennis ball image.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Search an image URL for tennis balls</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>urls <span class="op">=</span> search_images(searches[<span class="st">'tennis'</span>], max_images<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>urls[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'tennis ball photo'</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>'https://www.thoughtco.com/thmb/rC73Tl0nBlYStXTVXrCRAnhPaq8=/3888x2592/filters:fill(auto,1)/tennis-ball-on-tennis-court-125847528-58db9de83df78c5162dba2ee.jpg'</code></pre>
</div>
</div>
<p>Define a local path to store all the downloaded images.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Define a local path that will be root directory for this project</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># All the artifacts related to this post will be stored under this folder</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>local_path <span class="op">=</span> <span class="st">"./datasets/2022-08-10-sagemaker-fastai-classifier"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Download a sample image and view it.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Download an image using its URL, and show it as a thumbnail</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastdownload <span class="im">import</span> download_url</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>dest <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>local_path<span class="sc">}</span><span class="ss">/sample/tennis_ball.jpg'</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>download_url(urls[<span class="dv">0</span>], dest, show_progress<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(dest)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>im.to_thumb(<span class="dv">256</span>,<span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.8/site-packages/torchvision/io/image.py:11: UserWarning: Failed to load image Python extension: 
  warn(f"Failed to load image Python extension: {e}")</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="1015808" class="" max="1010004" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.57% [1015808/1010004 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-11-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>We have now downloaded a sample image from the Internet using the DuckDuckGo search engine and shown it as a thumbnail. For this, we have also used a few functions. So let’s deconstruct them to understand them better.</p>
<p>The first function we have used is <code>download_url</code>. Let’s check its documentation.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>??download_url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> download_url<span class="ansi-blue-fg">(</span>url<span class="ansi-blue-fg">,</span> dest<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> show_progress<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> download_url<span class="ansi-blue-fg">(</span>url<span class="ansi-blue-fg">,</span> dest<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> show_progress<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"Download `url` to `dest` and show progress"</span>
    pbar <span class="ansi-blue-fg">=</span> progress_bar<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> progress<span class="ansi-blue-fg">(</span>count<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> bsize<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span> tsize<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        pbar<span class="ansi-blue-fg">.</span>total <span class="ansi-blue-fg">=</span> tsize
        pbar<span class="ansi-blue-fg">.</span>update<span class="ansi-blue-fg">(</span>count<span class="ansi-blue-fg">*</span>bsize<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">return</span> urlsave<span class="ansi-blue-fg">(</span>url<span class="ansi-blue-fg">,</span> dest<span class="ansi-blue-fg">,</span> reporthook<span class="ansi-blue-fg">=</span>progress <span class="ansi-green-fg">if</span> show_progress <span class="ansi-green-fg">else</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> timeout<span class="ansi-blue-fg">=</span>timeout<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastdownload/core.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>This tells us that <strong>download_url</strong> function is from <code>fastdownload</code> library. This library is also published by the fastai team. Its purpose is “Easily download, verify, and extract archives”. You may read more about this library from its documentation site <a href="https://fastdownload.fast.ai/">fastdownload.fast.ai</a></p>
<p>The next function we have used is <code>Image.open</code>. Let’s check its documentation too.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>?Image.<span class="bu">open</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> Image<span class="ansi-blue-fg">.</span>open<span class="ansi-blue-fg">(</span>fp<span class="ansi-blue-fg">,</span> mode<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">'r'</span><span class="ansi-blue-fg">,</span> formats<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>
Opens and identifies the given image file.
This is a lazy operation; this function identifies the file, but
the file remains open and the actual image data is not read from
the file until you try to process the data (or call the
:py:meth:`~PIL.Image.Image.load` method).  See
:py:func:`~PIL.Image.new`. See :ref:`file-handling`.
:param fp: A filename (string), pathlib.Path object or a file object.
   The file object must implement ``file.read``,
   ``file.seek``, and ``file.tell`` methods,
   and be opened in binary mode.
:param mode: The mode.  If given, this argument must be "r".
:param formats: A list or tuple of formats to attempt to load the file in.
   This can be used to restrict the set of formats checked.
   Pass ``None`` to try all supported formats. You can print the set of
   available formats by running ``python3 -m PIL`` or using
   the :py:func:`PIL.features.pilinfo` function.
:returns: An :py:class:`~PIL.Image.Image` object.
:exception FileNotFoundError: If the file cannot be found.
:exception PIL.UnidentifiedImageError: If the image cannot be opened and
   identified.
:exception ValueError: If the ``mode`` is not "r", or if a ``StringIO``
   instance is used for ``fp``.
:exception TypeError: If ``formats`` is not ``None``, a list or a tuple.
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/PIL/Image.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that this function is from <strong>Python Pillow library</strong> and is used to open and read an image file. Refer to this library documentation for more information <a href="https://python-pillow.org/">python-pillow.org</a></p>
<p>The next function that we used is <code>Image.to_thumb</code>. Let’s check its documentation.</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>??Image.Image.to_thumb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> Image<span class="ansi-blue-fg">.</span>Image<span class="ansi-blue-fg">.</span>to_thumb<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'Image.Image'</span><span class="ansi-blue-fg">,</span> h<span class="ansi-blue-fg">,</span> w<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-blue-fg">@</span>patch
<span class="ansi-green-fg">def</span> to_thumb<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">:</span>Image<span class="ansi-blue-fg">.</span>Image<span class="ansi-blue-fg">,</span> h<span class="ansi-blue-fg">,</span> w<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"Same as `thumbnail`, but uses a copy"</span>
    <span class="ansi-green-fg">if</span> w <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> w<span class="ansi-blue-fg">=</span>h
    im <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>copy<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
    im<span class="ansi-blue-fg">.</span>thumbnail<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>w<span class="ansi-blue-fg">,</span>h<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">return</span> im
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/vision/core.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>So this function is actually from the <strong>fastai</strong> library, and its docstring tells us that it is the same as the Pillow library <code>thumbnail</code> function but uses a copy of the image.</p>
<p>Let’s check Pillow <strong>thumbnail</strong> function documentation as well.</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>?Image.Image.thumbnail</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> Image<span class="ansi-blue-fg">.</span>Image<span class="ansi-blue-fg">.</span>thumbnail<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> size<span class="ansi-blue-fg">,</span> resample<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">,</span> reducing_gap<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2.0</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>
Make this image into a thumbnail.  This method modifies the
image to contain a thumbnail version of itself, no larger than
the given size.  This method calculates an appropriate thumbnail
size to preserve the aspect of the image, calls the
:py:meth:`~PIL.Image.Image.draft` method to configure the file reader
(where applicable), and finally resizes the image.
Note that this function modifies the :py:class:`~PIL.Image.Image`
object in place.  If you need to use the full resolution image as well,
apply this method to a :py:meth:`~PIL.Image.Image.copy` of the original
image.
:param size: Requested size.
:param resample: Optional resampling filter.  This can be one
   of :py:data:`PIL.Image.NEAREST`, :py:data:`PIL.Image.BOX`,
   :py:data:`PIL.Image.BILINEAR`, :py:data:`PIL.Image.HAMMING`,
   :py:data:`PIL.Image.BICUBIC` or :py:data:`PIL.Image.LANCZOS`.
   If omitted, it defaults to :py:data:`PIL.Image.BICUBIC`.
   (was :py:data:`PIL.Image.NEAREST` prior to version 2.5.0).
   See: :ref:`concept-filters`.
:param reducing_gap: Apply optimization by resizing the image
   in two steps. First, reducing the image by integer times
   using :py:meth:`~PIL.Image.Image.reduce` or
   :py:meth:`~PIL.Image.Image.draft` for JPEG images.
   Second, resizing using regular resampling. The last step
   changes size no less than by ``reducing_gap`` times.
   ``reducing_gap`` may be None (no first step is performed)
   or should be greater than 1.0. The bigger ``reducing_gap``,
   the closer the result to the fair resampling.
   The smaller ``reducing_gap``, the faster resizing.
   With ``reducing_gap`` greater or equal to 3.0, the result is
   indistinguishable from fair resampling in most cases.
   The default value is 2.0 (very close to fair resampling
   while still being faster in many cases).
:returns: None
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/PIL/Image.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p><strong>Summary of the functions used till now</strong></p>
<p>Functions we have seen till now are summarized in this section.</p>
<ul>
<li><code>download_url</code>: Download <code>url</code> to <code>dest</code> and show progress. This function is from module <code>fastdownload\core.py</code>. <a href="https://fastdownload.fast.ai/">Fastdownload</a> is a separate library from the fastai team, and its use is to “Easily download, verify, and extract archives”.
<ul>
<li>Documentation: <a href="https://fastdownload.fast.ai/">fastdownload.fast.ai</a></li>
<li>Source code: <a href="https://github.com/fastai/fastdownload/blob/master/00_core.ipynb">fastai/fastdownload</a></li>
</ul></li>
<li><code>Image.open</code>: Opens and identifies the given image file. This is a lazy operation; this function identifies the file, but the file remains open, and the actual image data is not read from the file until you try to process the data. this function is from <code>pil\image.py</code> or <a href="https://pillow.readthedocs.io/en/stable/index.html">Python Pillow Image library</a>. Fastai installs this library for us. Fastai vision module internally loads Pillow for us. It has defined wrapper functions to make it easier to use this library in machine learning work.
<ul>
<li>Check fastai dependencies: <a href="https://github.com/fastai/fastai/blob/master/settings.ini#L16">settings.ini</a> It contains external dependent libraries that fastai installs for us. Some important libraries from that list include
<ul>
<li>fastdownload</li>
<li>fastcore</li>
<li>fastprogress</li>
<li>matplotlib</li>
<li>pandas</li>
<li>pillow</li>
<li>scikit-learn</li>
<li>pytorch</li>
</ul></li>
<li>Pillow image library documentation: https://pillow.readthedocs.io/en/stable/index.html</li>
<li><code>Image.open</code> documentation link: <a href="https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.open">PIL.Image.open</a></li>
</ul></li>
<li><code>Image.to_thumb</code>: Same as <code>thumbnail</code>, but uses a copy. This function is from <code>fastai\vision\core.py</code> module. It is a wrapper function around the PIL <strong>thumbnail</strong> function.
<ul>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/07_vision.core.ipynb">07_vision.core.ipynb</a></li>
</ul></li>
<li><code>Image.thumbnail</code>: Make this image into a thumbnail. This method modifies the image to contain a thumbnail version of itself, no larger than the given size. This method calculates an appropriate thumbnail size to preserve the image’s aspect, calls the draft() method to configure the file reader (where applicable), and finally resizes the image. Note that this function modifies the Image object in place. If you need to use the full resolution image, apply this method to a copy() of the original image. This function is from <code>pil\image.py</code>
<ul>
<li>Documentation: <a href="https://pillow.readthedocs.io/en/stable/reference/Image.html#PIL.Image.Image.thumbnail">PIL.Image.Image.thumbnail</a></li>
</ul></li>
</ul>
<p><strong>Summary of the steps performed till now</strong></p>
<ul>
<li>Defined a function to search images and return their URLs</li>
<li>Defined the search strings to find images on the Internet</li>
<li>Downloaded an image using its URL and showed it as a thumbnail</li>
</ul>
<p>Let’s proceed with our work. First, define a filesystem “images” path where files from the search engine will be downloaded.</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Define a folder path where downloaded images will be stored</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> Path(<span class="ss">f'</span><span class="sc">{</span>local_path<span class="sc">}</span><span class="ss">/images'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have used a <code>Path</code> class so let’s check its documentation.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>?Path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> Path<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>     
PurePath subclass that can make system calls.
Path represents a filesystem path but unlike PurePath, also offers
methods to do system calls on path objects. Depending on your system,
instantiating a Path will return either a PosixPath or a WindowsPath
object. You can also instantiate a PosixPath or WindowsPath directly,
but cannot instantiate a WindowsPath on a POSIX system or vice versa.
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/pathlib.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     PosixPath, WindowsPath
</pre>
</div>
</div>
</div>
<p>From the documentation, we find that the <code>Path</code> class is from Python standard library module <code>pathlib</code>. Python’s official documentation page for this module is <a href="https://docs.python.org/3/library/pathlib.html">pathlib.html</a>. We have not loaded this module, so it begs the question, who loaded it for us? When I checked the fastai code repository, I found a file named <a href="https://github.com/fastai/fastai/blob/master/fastai/imports.py">fastai/imports.py</a>. This file has many imports defined in it, and fastai is loading it for us behind the scenes. This <code>imports.py</code> file is loaded in many core fastai modules (data, vision, tabular, etc.). A typical loading sequence is as follows</p>
<ul>
<li><code>from fast.vision.all import *</code> loads <code>fastai.vision.core.py</code>
<ul>
<li>source code for <a href="https://github.com/fastai/fastai/blob/master/fastai/vision/all.py">fast.vision.all</a></li>
</ul></li>
<li><code>fastai.vision.core.py</code> loads <code>fastai.torch_basics.py</code>
<ul>
<li>source code for <a href="https://github.com/fastai/fastai/blob/master/fastai/vision/core.py">fastai.vision.core.py</a></li>
</ul></li>
<li><code>fastai.torch_basics.py</code> loads <code>fastai.imports.py</code>
<ul>
<li>source code for <a href="https://github.com/fastai/fastai/blob/master/fastai/torch_basics.py">fastai.torch_basics.py</a></li>
</ul></li>
<li><code>fastai.imports.py</code> loads <code>from pathlib import Path</code>
<ul>
<li>source code for <a href="https://github.com/fastai/fastai/blob/master/fastai/imports.py">fastai.imports.py</a></li>
</ul></li>
</ul>
<p>Okay, we have understood how Path library is loaded implicitly for us. So let’s continue with our work and download images using the search strings to the <code>Path</code> folder.</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Use each search string to search and download images</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, value <span class="kw">in</span> searches.items():</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    dest <span class="op">=</span> (path<span class="op">/</span>key)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    dest.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    download_images(dest, urls<span class="op">=</span>search_images(value))</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    resize_images(path<span class="op">/</span>key, max_size<span class="op">=</span><span class="dv">400</span>, dest<span class="op">=</span>path<span class="op">/</span>key)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.8/site-packages/PIL/Image.py:945: UserWarning: Palette images with Transparency expressed in bytes should be converted to RGBA images
  warnings.warn(
/opt/conda/lib/python3.8/site-packages/PIL/Image.py:945: UserWarning: Palette images with Transparency expressed in bytes should be converted to RGBA images
  warnings.warn(
/opt/conda/lib/python3.8/site-packages/PIL/Image.py:945: UserWarning: Palette images with Transparency expressed in bytes should be converted to RGBA images
  warnings.warn(
/opt/conda/lib/python3.8/site-packages/PIL/Image.py:945: UserWarning: Palette images with Transparency expressed in bytes should be converted to RGBA images
  warnings.warn(</code></pre>
</div>
</div>
<p>In the last cell, we have introduced another function <code>resize_images</code>. So let’s check its docs too.</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>?resize_images</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
resize_images<span class="ansi-blue-fg">(</span>
    path<span class="ansi-blue-fg">,</span>
    max_workers<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span>
    max_size<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    recurse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    dest<span class="ansi-blue-fg">=</span>Path<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">'.'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
    n_channels<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">,</span>
    ext<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    img_format<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    resample<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span>
    resume<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Resize files on path recursively to dest to max_size
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/vision/utils.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that this function is from the fastai vision module. Its purpose is to resize images to a given MAX size and store them in a destination folder. If any image size exceeds the max size, this function will resize it to a given size. Otherwise (smaller than max size), the image is left as it is.</p>
<p>So our images are now downloaded. Let’s check them.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Check the downloaded image files</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>fns <span class="op">=</span> get_image_files(path)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>fns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(#757) [Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/ee4bb413-b78d-4f2a-8e41-3f32bbad79a2.jpeg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/647709da-50e5-4344-8cd5-9895448d47dc.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/8a9378aa-6c9d-4456-8a8e-19ddc1a00354.jpeg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/84fd1455-607d-40c9-9454-8d06c18c8eab.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/20711509-3b5e-4b06-93e1-2013a1d40279.jpeg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/ae3b15ca-748b-4fdd-868d-e602bf37c79e.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/df19cf58-1da4-4dbc-8c9c-0224c6ffa32b.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/5775d55d-1c61-4477-aab5-0dd0feb9c5ba.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/31dfd24b-35ca-43fa-8cb9-5227b6ee9dac.jpg'),Path('datasets/2022-08-10-sagemaker-fastai-classifier/images/tennis/bf9ec4b8-f237-4030-b77b-ca02fcbf96c2.jpg')...]</code></pre>
</div>
</div>
<p>Checking the documentation for <code>get_image_files</code></p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>??get_image_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> get_image_files<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> recurse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> folders<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> get_image_files<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> recurse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> folders<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"Get image files in `path` recursively, only in `folders`, if specified."</span>
    <span class="ansi-green-fg">return</span> get_files<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> extensions<span class="ansi-blue-fg">=</span>image_extensions<span class="ansi-blue-fg">,</span> recurse<span class="ansi-blue-fg">=</span>recurse<span class="ansi-blue-fg">,</span> folders<span class="ansi-blue-fg">=</span>folders<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/data/transforms.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that this function is from the fastai data module. It gets image files in the directory recursively. Internally it is calling another function <code>get_files</code>. Let’s check it as well.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>??get_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
get_files<span class="ansi-blue-fg">(</span>
    path<span class="ansi-blue-fg">,</span>
    extensions<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    recurse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    folders<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    followlinks<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> get_files<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> extensions<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> recurse<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> folders<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> followlinks<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"Get all the files in `path` with optional `extensions`, optionally with `recurse`, only in `folders`, if specified."</span>
    path <span class="ansi-blue-fg">=</span> Path<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">)</span>
    folders<span class="ansi-blue-fg">=</span>L<span class="ansi-blue-fg">(</span>folders<span class="ansi-blue-fg">)</span>
    extensions <span class="ansi-blue-fg">=</span> setify<span class="ansi-blue-fg">(</span>extensions<span class="ansi-blue-fg">)</span>
    extensions <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">{</span>e<span class="ansi-blue-fg">.</span>lower<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> e <span class="ansi-green-fg">in</span> extensions<span class="ansi-blue-fg">}</span>
    <span class="ansi-green-fg">if</span> recurse<span class="ansi-blue-fg">:</span>
        res <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">for</span> i<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">(</span>p<span class="ansi-blue-fg">,</span>d<span class="ansi-blue-fg">,</span>f<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">in</span> enumerate<span class="ansi-blue-fg">(</span>os<span class="ansi-blue-fg">.</span>walk<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> followlinks<span class="ansi-blue-fg">=</span>followlinks<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-red-fg"># returns (dirpath, dirnames, filenames)</span>
            <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>folders<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">!=</span><span class="ansi-cyan-fg">0</span> <span class="ansi-green-fg">and</span> i<span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">:</span> d<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>o <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> d <span class="ansi-green-fg">if</span> o <span class="ansi-green-fg">in</span> folders<span class="ansi-blue-fg">]</span>
            <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>                         d<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>o <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> d <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> o<span class="ansi-blue-fg">.</span>startswith<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">'.'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>
            <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>folders<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">!=</span><span class="ansi-cyan-fg">0</span> <span class="ansi-green-fg">and</span> i<span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">0</span> <span class="ansi-green-fg">and</span> <span class="ansi-blue-fg">'.'</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">in</span> folders<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">continue</span>
            res <span class="ansi-blue-fg">+=</span> _get_files<span class="ansi-blue-fg">(</span>p<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> extensions<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
        f <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>o<span class="ansi-blue-fg">.</span>name <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> os<span class="ansi-blue-fg">.</span>scandir<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> o<span class="ansi-blue-fg">.</span>is_file<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span>
        res <span class="ansi-blue-fg">=</span> _get_files<span class="ansi-blue-fg">(</span>path<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> extensions<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">return</span> L<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/data/transforms.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>This tells us that this function is also from the fastai data module. It reads the files from the folder and returns their paths as “L” class objects. <code>L</code> class is new to us so let’s check what this class is about.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>?L</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> L<span class="ansi-blue-fg">(</span>items<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>rest<span class="ansi-blue-fg">,</span> use_list<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> match<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Behaves like a list of `items` but can also index with list of indices or masks
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastcore/foundation.py
<span class="ansi-red-fg">Type:</span>           _L_Meta
<span class="ansi-red-fg">Subclasses:</span>     TfmdLists, MultiCategory, LabeledBBox
</pre>
</div>
</div>
</div>
<p>It tells us that <code>L</code> class is from a separate library <code>fastcore</code>, also released by the fastai team. The purpose of this library is defined as <strong>Python supercharged for the fastai library</strong>. An important takeaway from this class documentation is that it extends the Python <code>list</code> functionality and calls it the <strong>L</strong> class. You may read more on this library from <a href="https://fastcore.fast.ai/">fastcore.fast.ai</a></p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Verify the downloaded images</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># If any image is corrupt then remove it.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>failed <span class="op">=</span> verify_images(fns)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>failed.<span class="bu">map</span>(Path.unlink)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(failed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>3</code></pre>
</div>
</div>
<p>A new function, <code>verify_images</code> is used in the above cell. First, let’s check its documentation.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>?verify_images</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> verify_images<span class="ansi-blue-fg">(</span>fns<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Find images in `fns` that can't be opened
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/vision/utils.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>This tells us that <strong>verify_images</strong> is from fastai vision module, and it simply returns images (Paths) that cannot be opened. So we removed these corrupt image files to make our data clean.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: print count of images downloaded against each search string</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> search <span class="kw">in</span> searches:</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    fns <span class="op">=</span> get_image_files(path<span class="op">/</span>search)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(search, <span class="st">"images count: "</span>, <span class="bu">len</span>(fns))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tennis images count:  189
cricket images count:  185
soccer images count:  193
basketball images count:  190</code></pre>
</div>
</div>
<p><strong>Summary of the functions used till now</strong></p>
<ul>
<li><code>Path</code>: Is from Python standard library <code>pathlib</code> module. fastai loads this module for us
<ul>
<li>Documentation: <a href="https://docs.python.org/3/library/pathlib.html">pathlib.html</a></li>
</ul></li>
<li><code>resize_images</code>: Is from fastai library vision module. Its purpose is to resize images to a given MAX size and store them in a destination folder
<ul>
<li>Documentation: <a href="https://docs.fast.ai/vision.utils.html#resize_image">vision.utils.html#resize_image</a></li>
<li>Souce code: <a href="https://github.com/fastai/fastai/blob/master/nbs/09b_vision.utils.ipynb">09b_vision.utils.ipynb</a></li>
</ul></li>
<li><code>get_image_files</code>: Is from fastai library data module. It returns a list (L class) of image file paths. Internally it calls <code>get_files</code> function
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.transforms.html#get_image_files">data.transforms.html#get_image_files</a></li>
<li>Souce code: <a href="https://github.com/fastai/fastai/blob/master/nbs/05_data.transforms.ipynb">05_data.transforms.ipynb</a></li>
</ul></li>
<li><code>get_files</code>: This is also from fastai library data module. It returns <code>L</code> class list of file paths
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.transforms.html#get_files">data.transforms.html#get_files</a></li>
<li>Souce code: <a href="https://github.com/fastai/fastai/blob/master/nbs/05_data.transforms.ipynb">05_data.transforms.ipynb</a></li>
</ul></li>
<li><code>L</code> class object: Is from fastcore library. It extends Python <code>list</code> object features
<ul>
<li>Documentation: <a href="https://fastcore.fast.ai/#l">fastcore.fast.ai/#l</a></li>
<li>Souce code: <a href="https://github.com/fastai/fastcore/blob/master/nbs/02_foundation.ipynb">02_foundation.ipynb</a></li>
</ul></li>
<li><code>verify_images</code>: Is from fastai library vision module. It verifies images and returns paths of images that cannot be opened
<ul>
<li>Documentation: <a href="https://docs.fast.ai/vision.utils.html#verify_images">vision.utils.html#verify_images</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/09b_vision.utils.ipynb">09b_vision.utils.ipynb</a></li>
</ul></li>
</ul>
<p><strong>Summary of the steps performed till now</strong></p>
<ul>
<li>Use each search string to search and download images to a local folder. Resize the downloaded images to a given size.</li>
<li>Get the downloaded images file paths as a list of type <code>L</code></li>
<li>Verify the images and remove any corrupted image</li>
</ul>
</section>
<section id="create-a-data-block" class="level1">
<h1>Create a data block</h1>
<p>We have our training data (images) downloaded in a folder. So let’s continue with our work and create a <code>DataBlock</code> on them.</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Create a data block</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>balls <span class="op">=</span> DataBlock(</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[Resize(<span class="dv">128</span>, method<span class="op">=</span><span class="st">'squish'</span>)]</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A “DataBlock” is like a package or a pipeline with instructions that tell the type of data we are dealing with and how we want to process it. It is like a blueprint that defines how we want to process our data. If you are coming from <code>scikit-learn</code> world, you may think of it as a sklearn <code>Pipeline</code> and <code>ColumnTransformer</code>. Let’s check this class documentation for a better understanding.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>?DataBlock</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
DataBlock<span class="ansi-blue-fg">(</span>
    blocks<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dl_type<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'TfmdDL'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    getters<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    n_inp<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    item_tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    batch_tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    get_items<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    splitter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_y<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_x<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Generic container to quickly build `Datasets` and `DataLoaders`.
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/data/block.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<p>It tells us that it is from fastai data module. On its usage, it says it is a <code>Generic container</code> to build <code>DataLoaders</code>. Let’s deconstruct the arguments we have passed to this class to understand them.</p>
<p>The first argument that we have passed is the <code>blocks</code>.</p>
<pre><code>blocks=(ImageBlock, CategoryBlock)</code></pre>
<p><code>blocks</code> are themselves predefined domain-specific containers (or pipelines) with default transformations defined for common use cases. For example, <strong>CategoryBlock</strong> is for “single-label categorical targets”. And the default transformations for this type of data are</p>
<ul>
<li>Encode categories like one-hot-encoding</li>
<li>sort them</li>
<li>fill empty values</li>
</ul>
<p>Similary, many other built-in blocks are available in the fastai library for various data types and domains. All these blocks are like pipelines with default transformations defined (or simply generic containers with a set of instructions). So, by <code>blocks=(ImageBlock, CategoryBlock)</code>, we are defining a blueprint and saying that for <code>X</code> and <code>y</code> of our data, treat them with <code>ImageBlock</code> and <code>CategoryBlock</code>, respectively. Here <code>X</code> is our training data (or images), and <code>y</code> is our labels i.e.&nbsp;tennis ball, cricket ball, etc.</p>
<p>The next argument in DataBlock is <code>get_items</code></p>
<pre><code>get_items=get_image_files</code></pre>
<p>It tells the blueprint on how to get the data items. Data items in our case are images, and we are telling it to use “get_image_files” function to get the image paths.</p>
<p>Then we pass the argument “splitter”</p>
<pre><code>splitter=RandomSplitter(valid_pct=0.2, seed=42),</code></pre>
<p>Here we are telling the DataBlock how to split the data.</p>
<p>Note that each DataBlock blueprint requires four things: the types of your input/labels (or blocks), and at least two functions: get_items and splitter.</p>
<p>We have passed a class <code>RandomSplitter</code> for a splitting strategy. Let’s check this class doc for more clarity.</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>?RandomSplitter</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> RandomSplitter<span class="ansi-blue-fg">(</span>valid_pct<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.2</span><span class="ansi-blue-fg">,</span> seed<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Create function that splits `items` between train/val with `valid_pct` randomly.
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/data/transforms.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>This class is also from the fastai data module, and it randomly splits the data into two sets: train and validation.</p>
<p>In the <code>DataBlock</code> constructor, we also passed an argument <code>get_y</code> that defined how to get the labels. Note that we have not defined anything for <code>X</code>, so the library will automatically take the data found in <code>get_items</code> as X. for <code>get_y</code> we have passed a class <code>parent_label</code>. Let’s check its documentation to understand what it is for.</p>
<pre><code>get_y=parent_label</code></pre>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>?parent_label</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> parent_label<span class="ansi-blue-fg">(</span>o<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Label `item` with the parent folder name.
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/data/transforms.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells that it is another class from the fastai data module and returns <code>labels</code> derived from the parent folder name. Meaning that all my cricket ball images are placed in a folder name <code>cricket,</code> so this class will automatically label all the images under it as <code>cricket</code>.</p>
<p>The last argument we have passed is <code>item_tfms</code> (item transformations). This argument defines if we want to apply any other transformation besides those described in blocks on each data point. Here we are telling it to use the <code>Resize</code> method on each item (from X). What does this function do? Let’s check the docs.</p>
<pre><code>item_tfms=[Resize(128, method='squish')]</code></pre>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse_output</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>??Resize</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
Resize<span class="ansi-blue-fg">(</span>
    self<span class="ansi-blue-fg">,</span>
    size<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int | tuple'</span><span class="ansi-blue-fg">,</span>
    method<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'ResizeMethod'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">'crop'</span><span class="ansi-blue-fg">,</span>
    pad_mode<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'PadMode'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">'reflection'</span><span class="ansi-blue-fg">,</span>
    resamples<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      A transform that before_call its state at each `__call__`
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> Resize<span class="ansi-blue-fg">(</span>RandTransform<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    split_idx<span class="ansi-blue-fg">,</span>mode<span class="ansi-blue-fg">,</span>mode_mask<span class="ansi-blue-fg">,</span>order <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>BILINEAR<span class="ansi-blue-fg">,</span>NEAREST<span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">1</span>
    <span class="ansi-blue-fg">"Resize image to `size` using `method`"</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        size<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">|</span>tuple<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Size to resize to, duplicated if one value is specified</span>
        method<span class="ansi-blue-fg">:</span>ResizeMethod<span class="ansi-blue-fg">=</span>ResizeMethod<span class="ansi-blue-fg">.</span>Crop<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># A `ResizeMethod`</span>
        pad_mode<span class="ansi-blue-fg">:</span>PadMode<span class="ansi-blue-fg">=</span>PadMode<span class="ansi-blue-fg">.</span>Reflection<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># A `PadMode`</span>
        resamples<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span>BILINEAR<span class="ansi-blue-fg">,</span> NEAREST<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Pillow `Image` resamples mode, resamples[1] for mask</span>
        <span class="ansi-blue-fg">**</span>kwargs
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        size <span class="ansi-blue-fg">=</span> _process_sz<span class="ansi-blue-fg">(</span>size<span class="ansi-blue-fg">)</span>
        store_attr<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>mode<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>mode_mask <span class="ansi-blue-fg">=</span> resamples
    <span class="ansi-green-fg">def</span> before_call<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        b<span class="ansi-blue-fg">,</span> 
        split_idx<span class="ansi-blue-fg">:</span>int <span class="ansi-red-fg"># Index of the train/valid dataset</span>
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>method<span class="ansi-blue-fg">==</span>ResizeMethod<span class="ansi-blue-fg">.</span>Squish<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>
        self<span class="ansi-blue-fg">.</span>pcts <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.5</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0.5</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> split_idx <span class="ansi-green-fg">else</span> <span class="ansi-blue-fg">(</span>random<span class="ansi-blue-fg">.</span>random<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>random<span class="ansi-blue-fg">.</span>random<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> encodes<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> x<span class="ansi-blue-fg">:</span>Image<span class="ansi-blue-fg">.</span>Image<span class="ansi-blue-fg">|</span>TensorBBox<span class="ansi-blue-fg">|</span>TensorPoint<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        orig_sz <span class="ansi-blue-fg">=</span> _get_sz<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>method<span class="ansi-blue-fg">==</span>ResizeMethod<span class="ansi-blue-fg">.</span>Squish<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">return</span> x<span class="ansi-blue-fg">.</span>crop_pad<span class="ansi-blue-fg">(</span>orig_sz<span class="ansi-blue-fg">,</span> fastuple<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> orig_sz<span class="ansi-blue-fg">=</span>orig_sz<span class="ansi-blue-fg">,</span> pad_mode<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>pad_mode<span class="ansi-blue-fg">,</span>
                   resize_mode<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>mode_mask <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span>PILMask<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">else</span> self<span class="ansi-blue-fg">.</span>mode<span class="ansi-blue-fg">,</span> resize_to<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">)</span>
        w<span class="ansi-blue-fg">,</span>h <span class="ansi-blue-fg">=</span> orig_sz
        op <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>operator<span class="ansi-blue-fg">.</span>lt<span class="ansi-blue-fg">,</span>operator<span class="ansi-blue-fg">.</span>gt<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>method<span class="ansi-blue-fg">==</span>ResizeMethod<span class="ansi-blue-fg">.</span>Pad<span class="ansi-blue-fg">]</span>
        m <span class="ansi-blue-fg">=</span> w<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">if</span> op<span class="ansi-blue-fg">(</span>w<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>h<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">else</span> h<span class="ansi-blue-fg">/</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span>
        cp_sz <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>int<span class="ansi-blue-fg">(</span>m<span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>int<span class="ansi-blue-fg">(</span>m<span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        tl <span class="ansi-blue-fg">=</span> fastuple<span class="ansi-blue-fg">(</span>int<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>pcts<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>w<span class="ansi-blue-fg">-</span>cp_sz<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> int<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>pcts<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">(</span>h<span class="ansi-blue-fg">-</span>cp_sz<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> x<span class="ansi-blue-fg">.</span>crop_pad<span class="ansi-blue-fg">(</span>cp_sz<span class="ansi-blue-fg">,</span> tl<span class="ansi-blue-fg">,</span> orig_sz<span class="ansi-blue-fg">=</span>orig_sz<span class="ansi-blue-fg">,</span> pad_mode<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>pad_mode<span class="ansi-blue-fg">,</span>
                   resize_mode<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>mode_mask <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span>PILMask<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">else</span> self<span class="ansi-blue-fg">.</span>mode<span class="ansi-blue-fg">,</span> resize_to<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/vision/augment.py
<span class="ansi-red-fg">Type:</span>           _TfmMeta
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<p>It tells us that this class is from the fastai vision module, but the docstring is not very helpful. Overall the impression is that this function internally uses the Pillow library and helps resize images. It utilizes multiple techniques to make all images of the same size like padding, cropping, reflection, squish, etc. Here we want all the pictures of the exact same size. Previously we have seen a similar function while downloading images (resize_images), which applied to the images max size.</p>
</section>
<section id="create-a-data-loader-and-show-batch" class="level1">
<h1>Create a data loader and show batch</h1>
<p>In the last section, we created a blueprint that defines the type of data we are dealing with and some transformations for it. We call it <strong>DataBlock</strong>. But a DataBlock is just a set of instructions as it does not point to any data. When we group a DataBlock with the actual data, we get a <code>Dataset</code>. But in machine learning workloads, we commonly deal with batches of data from the same dataset. For this, we have an iterator class over “Dataset” that creates batches from the given dataset for us. We call it <code>DataLoaders</code>. Both these concepts come from <code>Pytorch</code> on which fastai has its roots. So let’s first learn about these new concepts directly from Pytorch documentation.</p>
<blockquote class="blockquote">
<p>Code for processing data samples can get messy and hard to maintain; we ideally want our dataset code to be decoupled from our model training code for better readability and modularity. PyTorch provides two data primitives: <code>torch.utils.data.DataLoader</code> and <code>torch.utils.data.Dataset</code> that allow you to use pre-loaded datasets as well as your own data. Dataset stores the samples and their corresponding labels, and DataLoader wraps an iterable around the Dataset to enable easy access to the samples.</p>
</blockquote>
<p>Read more about it from Pytorch documentation <a href="https://pytorch.org/tutorials/beginner/basics/data_tutorial.html">data_tutorial.html</a></p>
<p>What fastai provides is that it builds on these Pytorch constructs and extends their functionality. You can say that while working with Pytorch fastai team found many repeated steps for everyday tasks in their machine learning work. So they created higher-level functions in fastai that do many of these repeated and common tasks for us (though internally, it is still using Pytorch). This way, we developers can achieve more with fewer lines of code in fastai. So using fastai, we don’t need to create a Dataset and then a Dataloader. Instead, we can get a <code>Dataloader</code> by pointing our <code>DataBlock</code> to data and asking it to return a DataLoader. In the next cell, we are doing that.</p>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Create a DataLoader</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> balls.dataloaders(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To complete the picture, let’s also check the documentation of <code>Datasets</code> from the fastai library.</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>?Datasets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
Datasets<span class="ansi-blue-fg">(</span>
    items<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    tfms<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list | Pipeline'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    tls<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'TfmdLists'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    n_inp<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    dl_type<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    use_list<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    do_setup<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    split_idx<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    train_setup<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    splits<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'list'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    types<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    verbose<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      A dataset that creates a tuple from each `tfms`
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<p>It tells us that it is defined in fastai data module.</p>
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.core.html#datasets">data.core.html#datasets</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/03_data.core.ipynb">03_data.core.ipynb</a></li>
</ul>
<p>Let’s do the same for <code>DataLoaders</code> and check its documentation.</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>?DataLoaders</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> DataLoaders<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>loaders<span class="ansi-blue-fg">,</span> path<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'str | Path'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">'.'</span><span class="ansi-blue-fg">,</span> device<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Basic wrapper around several `DataLoader`s.
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     ImageDataLoaders, SegmentationDataLoaders
</pre>
</div>
</div>
</div>
<p>It tells us that <strong>DataLoaders</strong> class is also defined in fastai library data module.</p>
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.core.html#dataloaders">data.core.html#dataloaders</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/03_data.core.ipynb">03_data.core.ipynb</a></li>
</ul>
<p>Important notes from <strong>DataLoaders</strong> documentation:</p>
<ul>
<li><code>DataLoaders.train</code>: Training DataLoader</li>
<li><code>DataLoaders.valid</code>: Validation DataLoader</li>
<li><code>DataLoaders.train_ds</code>: Training Dataset</li>
<li><code>DataLoaders.valid_ds</code>: Validation Dataset</li>
</ul>
<p>We can also check the data loader object’s data type to confirm its class name and origin.</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># dataloader object type</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(dls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>fastai.data.core.DataLoaders</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># check types for dataloaders.train and dataloaders.valid</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(dls.train))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">type</span>(dls.valid))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'fastai.data.core.TfmdDL'&gt;
&lt;class 'fastai.data.core.TfmdDL'&gt;</code></pre>
</div>
</div>
<p>Data type for <code>dls.train</code> and <code>dls.valid</code> are of a different class. Let’s check the documentation for <code>TfmdDL</code> to get more clarity.</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>??TfmdDL</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
TfmdDL<span class="ansi-blue-fg">(</span>
    dataset<span class="ansi-blue-fg">,</span>
    bs<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">64</span><span class="ansi-blue-fg">,</span>
    shuffle<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    num_workers<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    verbose<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    do_setup<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    pin_memory<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    timeout<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>
    batch_size<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    drop_last<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    indexed<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    n<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    device<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    persistent_workers<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    pin_memory_device<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">''</span><span class="ansi-blue-fg">,</span>
    wif<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    before_iter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_item<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    before_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_iter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_batches<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_item<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    retain<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_idxs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    sample<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    shuffle_fn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    do_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>        
<span class="ansi-green-fg">class</span> TfmdDL<span class="ansi-blue-fg">(</span>DataLoader<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"Transformed `DataLoader`"</span>
    <span class="ansi-green-fg">def</span> __init__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        dataset<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Map- or iterable-style dataset from which to load the data</span>
        bs<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">64</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Size of batch</span>
        shuffle<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to shuffle data</span>
        num_workers<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Number of CPU cores to use in parallel (default: All available up to 16)</span>
        verbose<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to print verbose logs</span>
        do_setup<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to run `setup()` for batch transform(s)</span>
        <span class="ansi-blue-fg">**</span>kwargs
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> num_workers <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> num_workers <span class="ansi-blue-fg">=</span> min<span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">16</span><span class="ansi-blue-fg">,</span> defaults<span class="ansi-blue-fg">.</span>cpus<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">for</span> nm <span class="ansi-green-fg">in</span> _batch_tfms<span class="ansi-blue-fg">:</span> kwargs<span class="ansi-blue-fg">[</span>nm<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> Pipeline<span class="ansi-blue-fg">(</span>kwargs<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span>nm<span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>__init__<span class="ansi-blue-fg">(</span>dataset<span class="ansi-blue-fg">,</span> bs<span class="ansi-blue-fg">=</span>bs<span class="ansi-blue-fg">,</span> shuffle<span class="ansi-blue-fg">=</span>shuffle<span class="ansi-blue-fg">,</span> num_workers<span class="ansi-blue-fg">=</span>num_workers<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> do_setup<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">for</span> nm <span class="ansi-green-fg">in</span> _batch_tfms<span class="ansi-blue-fg">:</span>
                pv<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f"Setting up {nm}: {kwargs[nm]}"</span><span class="ansi-blue-fg">,</span> verbose<span class="ansi-blue-fg">)</span>
                kwargs<span class="ansi-blue-fg">[</span>nm<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>setup<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _one_pass<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        b <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>do_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>do_item<span class="ansi-blue-fg">(</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>device <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">not</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> b <span class="ansi-blue-fg">=</span> to_device<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>device<span class="ansi-blue-fg">)</span>
        its <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>after_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
        self<span class="ansi-blue-fg">.</span>_n_inp <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> isinstance<span class="ansi-blue-fg">(</span>its<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">(</span>list<span class="ansi-blue-fg">,</span>tuple<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">or</span> len<span class="ansi-blue-fg">(</span>its<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">==</span><span class="ansi-cyan-fg">1</span> <span class="ansi-green-fg">else</span> len<span class="ansi-blue-fg">(</span>its<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span>
        self<span class="ansi-blue-fg">.</span>_types <span class="ansi-blue-fg">=</span> explode_types<span class="ansi-blue-fg">(</span>its<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _retain_dl<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'_types'</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>_one_pass<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> retain_types<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> typs<span class="ansi-blue-fg">=</span>self<span class="ansi-blue-fg">.</span>_types<span class="ansi-blue-fg">)</span>
    <span class="ansi-blue-fg">@</span>delegates<span class="ansi-blue-fg">(</span>DataLoader<span class="ansi-blue-fg">.</span>new<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> new<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        dataset<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Map- or iterable-style dataset from which to load the data</span>
        cls<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Class of the newly created `DataLoader` object</span>
        <span class="ansi-blue-fg">**</span>kwargs
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        res <span class="ansi-blue-fg">=</span> super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>new<span class="ansi-blue-fg">(</span>dataset<span class="ansi-blue-fg">,</span> cls<span class="ansi-blue-fg">,</span> do_setup<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'_n_inp'</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">or</span> <span class="ansi-green-fg">not</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'_types'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
                self<span class="ansi-blue-fg">.</span>_one_pass<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
                res<span class="ansi-blue-fg">.</span>_n_inp<span class="ansi-blue-fg">,</span>res<span class="ansi-blue-fg">.</span>_types <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_n_inp<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>_types
            <span class="ansi-green-fg">except</span> Exception <span class="ansi-green-fg">as</span> e<span class="ansi-blue-fg">:</span> 
                print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">"Could not do one pass in your dataloader, there is something wrong in it. Please see the stack trace below:"</span><span class="ansi-blue-fg">)</span>
                <span class="ansi-green-fg">raise</span>
        <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span> res<span class="ansi-blue-fg">.</span>_n_inp<span class="ansi-blue-fg">,</span>res<span class="ansi-blue-fg">.</span>_types <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_n_inp<span class="ansi-blue-fg">,</span>self<span class="ansi-blue-fg">.</span>_types
        <span class="ansi-green-fg">return</span> res
    <span class="ansi-green-fg">def</span> before_iter<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        super<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>before_iter<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        split_idx <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'split_idx'</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">for</span> nm <span class="ansi-green-fg">in</span> _batch_tfms<span class="ansi-blue-fg">:</span>
            f <span class="ansi-blue-fg">=</span> getattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>nm<span class="ansi-blue-fg">)</span>
            <span class="ansi-green-fg">if</span> isinstance<span class="ansi-blue-fg">(</span>f<span class="ansi-blue-fg">,</span>Pipeline<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> f<span class="ansi-blue-fg">.</span>split_idx<span class="ansi-blue-fg">=</span>split_idx
    <span class="ansi-green-fg">def</span> decode<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        b <span class="ansi-red-fg"># Batch to decode</span>
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-green-fg">return</span> to_cpu<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>after_batch<span class="ansi-blue-fg">.</span>decode<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_retain_dl<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> decode_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        b<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Batch to decode</span>
        max_n<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Maximum number of items to decode</span>
        full<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span> <span class="ansi-red-fg"># Whether to decode all transforms. If `False`, decode up to the point the item knows how to show itself</span>
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> 
        <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_decode_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>decode<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">,</span> full<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _decode_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span> full<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        f <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>after_item<span class="ansi-blue-fg">.</span>decode
        f1 <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>before_batch<span class="ansi-blue-fg">.</span>decode
        f <span class="ansi-blue-fg">=</span> compose<span class="ansi-blue-fg">(</span>f1<span class="ansi-blue-fg">,</span> f<span class="ansi-blue-fg">,</span> partial<span class="ansi-blue-fg">(</span>getcallable<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">'decode'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> full <span class="ansi-blue-fg">=</span> full<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> L<span class="ansi-blue-fg">(</span>batch_to_samples<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>map<span class="ansi-blue-fg">(</span>f<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">def</span> _pre_show_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"Decode `b` to be ready for `show_batch`"</span>
        b <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>decode<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'show'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> b<span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span>
        its <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_decode_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">,</span> full<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> is_listy<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> b<span class="ansi-blue-fg">,</span>its <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>b<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>L<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>o<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">for</span> o <span class="ansi-green-fg">in</span> its<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> detuplify<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span>self<span class="ansi-blue-fg">.</span>n_inp<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>detuplify<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>n_inp<span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>its
    <span class="ansi-green-fg">def</span> show_batch<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span>
        b<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Batch to show</span>
        max_n<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Maximum number of items to show</span>
        ctxs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># List of `ctx` objects to show data. Could be matplotlib axis, DataFrame etc</span>
        show<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to display data</span>
        unique<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to show only one </span>
        <span class="ansi-blue-fg">**</span>kwargs
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"Show `max_n` input(s) and target(s) from the batch."</span>
        <span class="ansi-green-fg">if</span> unique<span class="ansi-blue-fg">:</span>
            old_get_idxs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>get_idxs
            self<span class="ansi-blue-fg">.</span>get_idxs <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">lambda</span><span class="ansi-blue-fg">:</span> Inf<span class="ansi-blue-fg">.</span>zeros
        <span class="ansi-green-fg">if</span> b <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">:</span> b <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>one_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> show<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_pre_show_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">)</span>
        show_batch<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>self<span class="ansi-blue-fg">.</span>_pre_show_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> ctxs<span class="ansi-blue-fg">=</span>ctxs<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> unique<span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>get_idxs <span class="ansi-blue-fg">=</span> old_get_idxs
    <span class="ansi-green-fg">def</span> show_results<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        b<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Batch to show results for</span>
        out<span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Predicted output from model for the batch</span>
        max_n<span class="ansi-blue-fg">:</span>int<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Maximum number of items to show</span>
        ctxs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># List of `ctx` objects to show data. Could be matplotlib axis, DataFrame etc</span>
        show<span class="ansi-blue-fg">:</span>bool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-red-fg"># Whether to display data</span>
        <span class="ansi-blue-fg">**</span>kwargs
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"Show `max_n` results with input(s), target(s) and prediction(s)."</span>
        x<span class="ansi-blue-fg">,</span>y<span class="ansi-blue-fg">,</span>its <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>show_batch<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">,</span> show<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>
        b_out <span class="ansi-blue-fg">=</span> type<span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">(</span>b<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span>self<span class="ansi-blue-fg">.</span>n_inp<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">+</span> <span class="ansi-blue-fg">(</span>tuple<span class="ansi-blue-fg">(</span>out<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> is_listy<span class="ansi-blue-fg">(</span>out<span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">else</span> <span class="ansi-blue-fg">(</span>out<span class="ansi-blue-fg">,</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        x1<span class="ansi-blue-fg">,</span>y1<span class="ansi-blue-fg">,</span>outs <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>show_batch<span class="ansi-blue-fg">(</span>b_out<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">,</span> show<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">)</span>
        res <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span>x1<span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span> <span class="ansi-green-fg">if</span> its <span class="ansi-green-fg">is</span> <span class="ansi-green-fg">None</span> <span class="ansi-green-fg">else</span> <span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> y<span class="ansi-blue-fg">,</span> its<span class="ansi-blue-fg">,</span> outs<span class="ansi-blue-fg">.</span>itemgot<span class="ansi-blue-fg">(</span>slice<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>n_inp<span class="ansi-blue-fg">,</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> show<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> res
        show_results<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>res<span class="ansi-blue-fg">,</span> ctxs<span class="ansi-blue-fg">=</span>ctxs<span class="ansi-blue-fg">,</span> max_n<span class="ansi-blue-fg">=</span>max_n<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
    <span class="ansi-blue-fg">@</span>property
    <span class="ansi-green-fg">def</span> n_inp<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> int<span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"Number of elements in `Datasets` or `TfmdDL` tuple to be considered part of input."</span>
        <span class="ansi-green-fg">if</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'n_inp'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">.</span>n_inp
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> hasattr<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'_n_inp'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> self<span class="ansi-blue-fg">.</span>_one_pass<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_n_inp
    <span class="ansi-green-fg">def</span> to<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> 
        device <span class="ansi-red-fg"># Device to put `DataLoader` and transforms</span>
    <span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        self<span class="ansi-blue-fg">.</span>device <span class="ansi-blue-fg">=</span> device
        <span class="ansi-green-fg">for</span> tfm <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>after_batch<span class="ansi-blue-fg">.</span>fs<span class="ansi-blue-fg">:</span>
            <span class="ansi-green-fg">for</span> a <span class="ansi-green-fg">in</span> L<span class="ansi-blue-fg">(</span>getattr<span class="ansi-blue-fg">(</span>tfm<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">'parameters'</span><span class="ansi-blue-fg">,</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> setattr<span class="ansi-blue-fg">(</span>tfm<span class="ansi-blue-fg">,</span> a<span class="ansi-blue-fg">,</span> getattr<span class="ansi-blue-fg">(</span>tfm<span class="ansi-blue-fg">,</span> a<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> self
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     TabDataLoader, WeightedDL, PartialDL
</pre>
</div>
</div>
</div>
<p>It tells us that it is a class derived from <code>Dataloader</code> and calls it <strong>Transformed DataLoader</strong>. It is defined in fastai data module. Its purpose is defined as</p>
<blockquote class="blockquote">
<p>A TfmdDL is a DataLoader that creates Pipeline from a list of Transforms for the callbacks after_item, before_batch and after_batch. As a result, it can decode or show a processed batch</p>
</blockquote>
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.core.html#tfmddl">data.core.html#tfmddl</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/03_data.core.ipynb">03_data.core.ipynb</a></li>
</ul>
<p>To clarify, <code>DataLoaders</code> and <code>DataLoader</code> are two separate classes.</p>
<ul>
<li>our object “dls” is of <strong>DataLoaders</strong> origin. This class is a wrapper around several <code>DataLoader</code>s. We have checked this class doc before</li>
<li>dls attributes “dls.train” and “dls.valid” are of <strong>DataLoader</strong> origin. <code>TfmdDL</code> (transformed data loader) is one of its kind, and we have seen its docs in the last cell.</li>
</ul>
<p>Let’s also visit the documentation for the <code>DataLoader</code> class from which <code>TfmdDL</code> is derived.</p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>?DataLoader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
DataLoader<span class="ansi-blue-fg">(</span>
    dataset<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    bs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    num_workers<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>
    pin_memory<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    timeout<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>
    batch_size<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    shuffle<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    drop_last<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    indexed<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    n<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    device<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    persistent_workers<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    pin_memory_device<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">''</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    wif<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    before_iter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_item<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    before_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    after_iter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_batches<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_item<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    create_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    retain<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    get_idxs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    sample<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    shuffle_fn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    do_batch<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      API compatible with PyTorch DataLoader, with a lot more callbacks and flexibility
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/data/load.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     TfmdDL
</pre>
</div>
</div>
</div>
<p>It tells us that it is an extension to PyTorch DataLoader with more flexibility (or functionality). This class is defined in fastai data module.</p>
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.load.html#dataloader">data.load.html#dataloader</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/02_data.load.ipynb">02_data.load.ipynb</a></li>
</ul>
<p>Let us continue with our work and visualize a small batch from our validation set.</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Show a small batch from validation set</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>dls.valid.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, nrows<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-39-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Show a small batch from training set</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>dls.train.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, nrows<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<p><code>show_batch</code> is a very convenient function from fastai with which you can quickly verify a sample from the training dataset. You can also check that all the images are of the same size and have been appropriately labeled. Let’s quickly review the docs for this function.</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>?TfmdDL.show_batch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
TfmdDL<span class="ansi-blue-fg">.</span>show_batch<span class="ansi-blue-fg">(</span>
    self<span class="ansi-blue-fg">,</span>
    b<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    max_n<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'int'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">9</span><span class="ansi-blue-fg">,</span>
    ctxs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    show<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    unique<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Show `b` (defaults to `one_batch`), a list of lists of pipeline outputs (i.e. output of a `DataLoader`)
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/data/core.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p><strong>Summary of the functions used till now</strong></p>
<ul>
<li><code>DataBlock</code>: Is from fastai data module. It is a generic container to build <code>DataLoaders</code>
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.block.html#datablock">data.block.html#datablock</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/06_data.block.ipynb">06_data.block.ipynb</a></li>
</ul></li>
<li><code>DataBlock.dataloaders(Path)</code>: to create a <code>DataLoaders</code> object from <code>DataBlock</code></li>
<li><code>DataLoaders</code>: Is from fastai library data module. It is a basic wrapper around several <code>DataLoader</code>s
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.core.html#dataloaders">data.core.html#dataloaders</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/03_data.core.ipynb">03_data.core.ipynb</a></li>
</ul></li>
<li><code>DataLoader</code>: Is an extension to PyTorch DataLoader with more flexibility (or functionality). This class is defined in fastai data module.
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.load.html#dataloader">data.load.html#dataloader</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/02_data.load.ipynb">02_data.load.ipynb</a></li>
</ul></li>
<li><code>TfmdDL</code>: A transformed DataLoader
<ul>
<li>Documentation: <a href="https://docs.fast.ai/data.core.html#tfmddl">data.core.html#tfmddl</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/03_data.core.ipynb">03_data.core.ipynb</a></li>
</ul></li>
</ul>
<p><strong>Summary of the steps till now</strong></p>
<ul>
<li>Created a DataBlock object</li>
<li>Created a DataLoaders object</li>
<li>Viewed a small batch using <code>show_batch</code> function</li>
</ul>
</section>
<section id="train-an-image-classifier" class="level1">
<h1>Train an image classifier</h1>
<p>At this point, our data is ready for training. Let’s train an image classifier on this data.</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Train an image classifier</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>error_rate)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>1.900133</td>
      <td>0.625038</td>
      <td>0.192053</td>
      <td>00:26</td>
    </tr>
  </tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>error_rate</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.623933</td>
      <td>0.692287</td>
      <td>0.192053</td>
      <td>00:37</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.440623</td>
      <td>0.726005</td>
      <td>0.192053</td>
      <td>00:36</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.325829</td>
      <td>0.649467</td>
      <td>0.192053</td>
      <td>00:36</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<p>In the last cell, we have performed two steps:</p>
<ol type="1">
<li>Created a vision learner using a <code>vision_learner()</code> method</li>
<li>Then used the learner object <code>fine_tune()</code> method to train a model</li>
</ol>
<p>Let’s deconstruct these two steps. First, check the documentation on the <code>vision_learner</code> function.</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>?vision_learner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
vision_learner<span class="ansi-blue-fg">(</span>
    dls<span class="ansi-blue-fg">,</span>
    arch<span class="ansi-blue-fg">,</span>
    normalize<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    n_out<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    pretrained<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    loss_func<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    opt_func<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&lt;</span>function Adam at <span class="ansi-cyan-fg">0x7ff9747445e0</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    lr<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.001</span><span class="ansi-blue-fg">,</span>
    splitter<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    metrics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    path<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    model_dir<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">'models'</span><span class="ansi-blue-fg">,</span>
    wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    wd_bn_bias<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    train_bn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    moms<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.85</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
    cut<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    init<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&lt;</span>function kaiming_normal_ at <span class="ansi-cyan-fg">0x7ff9912824c0</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    custom_head<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    concat_pool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    pool<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    lin_ftrs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    ps<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.5</span><span class="ansi-blue-fg">,</span>
    first_bn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    bn_final<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    lin_first<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    y_range<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    n_in<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">3</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Build a vision learner from `dls` and `arch`
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/vision/learner.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that this method is from the fastai vision module, and the docstring says that its purpose is to “Build a vision learner from <code>dls</code> and <code>arch</code>”. We are getting limited information here. So let’s check the documentation pages <a href="https://docs.fast.ai/vision.learner.html#learner-convenience-functions">vision.learner.html#learner-convenience-functions</a>. From the documentation page, we get the following information</p>
<ul>
<li>It is a “convenience function” for <code>Learner</code> class objects</li>
<li>fastai “vision learner” module purpose is defined as “All the functions necessary to build Learner suitable for transfer learning in computer vision”
<ul>
<li>The most essential functions of this module are <em>vision_learner</em> and <em>unet_learner</em>.</li>
<li>They will help you define a <em>Learner</em> using a pre-trained model.</li>
</ul></li>
<li>Arguments passed to this function
<ul>
<li><code>dls</code> refers to DataLoaders object</li>
<li><code>arch</code> refers to model architecture to use</li>
</ul></li>
</ul>
<p>So basically, <code>vision_learner</code> is a helper function for <code>Learner</code> class to create its object. This means we need to understand the <code>Learner</code> concept to complete the picture.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>?Learner</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
Learner<span class="ansi-blue-fg">(</span>
    dls<span class="ansi-blue-fg">,</span>
    model<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'callable'</span><span class="ansi-blue-fg">,</span>
    loss_func<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'callable | None'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    opt_func<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">&lt;</span>function Adam at <span class="ansi-cyan-fg">0x7ff9747445e0</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    lr<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.001</span><span class="ansi-blue-fg">,</span>
    splitter<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'callable'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">&lt;</span>function trainable_params at <span class="ansi-cyan-fg">0x7ff9774ea790</span><span class="ansi-blue-fg">&gt;</span><span class="ansi-blue-fg">,</span>
    cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    metrics<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    path<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    model_dir<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">'models'</span><span class="ansi-blue-fg">,</span>
    wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    wd_bn_bias<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    train_bn<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
    moms<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.85</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">0.95</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span>
    default_cbs<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'bool'</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Group together a `model`, some `dls` and a `loss_func` to handle training
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/learner.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<p>It tells us that a <strong>Learner</strong> “Group together a <code>model</code>, some <code>dls</code> and a <code>loss_func</code> to handle training”. It is also a container that combines data, model, and a loss function into a single pipeline; we get this pipeline using a helper function <code>vision_learner</code>. Let’s also check the type of our “learn” object.</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>fastai.learner.Learner</code></pre>
</div>
</div>
<p>Okay, the concept of <code>vision_learner</code> is clear. Let’s also discuss the arguments we have passed to it.</p>
<pre><code>learn = vision_learner(dls, resnet18, metrics=error_rate)</code></pre>
<ul>
<li><code>dls</code> we already know that it refers to DataLoaders object</li>
<li><code>resnet18</code> we know it is the <code>arch</code> or model architecture we want to use. But from which library/class are we using this object?</li>
<li><code>error_rate</code> we know that it refers to the error metric we want to use for training. But again, from which library/class are we using this object?</li>
</ul>
<p>Let’s check <code>resnet18</code> first.</p>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>?resnet18</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> resnet18<span class="ansi-blue-fg">(</span>pretrained<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> progress<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">:</span> Any<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> torchvision<span class="ansi-blue-fg">.</span>models<span class="ansi-blue-fg">.</span>resnet<span class="ansi-blue-fg">.</span>ResNet
<span class="ansi-red-fg">Docstring:</span>
ResNet-18 model from
`"Deep Residual Learning for Image Recognition" &lt;https://arxiv.org/pdf/1512.03385.pdf&gt;`_.
Args:
    pretrained (bool): If True, returns a model pre-trained on ImageNet
    progress (bool): If True, displays a progress bar of the download to stderr
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/torchvision/models/resnet.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that this model architecture is defined in <code>torchvision</code> library or <strong>PyTorch vision</strong> module. From the docstring, we get that it is a pre-trained “ResNet-18 model for <code>Deep Residual Learning for Image Recognition</code>”.</p>
<p>Let’s check the next argument, <code>error_rate</code>.</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>?error_rate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> error_rate<span class="ansi-blue-fg">(</span>inp<span class="ansi-blue-fg">,</span> targ<span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> 1 - `accuracy`
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/metrics.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that <strong>error_rate</strong> is defined in fastai library metrics module.</p>
<p>Now let’s go back to the image classifier training step and comprehend the second line.</p>
<pre><code>learn.fine_tune(3)</code></pre>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collapse-output</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>?Learner.fine_tune</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
Learner<span class="ansi-blue-fg">.</span>fine_tune<span class="ansi-blue-fg">(</span>
    self<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'Learner'</span><span class="ansi-blue-fg">,</span>
    epochs<span class="ansi-blue-fg">,</span>
    base_lr<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.002</span><span class="ansi-blue-fg">,</span>
    freeze_epochs<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>
    lr_mult<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">100</span><span class="ansi-blue-fg">,</span>
    pct_start<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0.3</span><span class="ansi-blue-fg">,</span>
    div<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">5.0</span><span class="ansi-blue-fg">,</span>
    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>
    lr_max<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    div_final<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">100000.0</span><span class="ansi-blue-fg">,</span>
    wd<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    moms<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    cbs<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
    reset_opt<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>
    start_epoch<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span> Fine tune with `Learner.freeze` for `freeze_epochs`, then with `Learner.unfreeze` for `epochs`, using discriminative LR.
<span class="ansi-red-fg">File:</span>      /opt/conda/lib/python3.8/site-packages/fastai/callback/schedule.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<p>It tells us that it is from fastai callback module, and its purpose is defined as “Fine tune with <code>Learner.freeze</code> for <code>freeze_epochs</code>, then with <code>Learner.unfreeze</code> for <code>epochs</code>, using discriminative LR.”</p>
<p><strong>Summary of the functions used till now</strong></p>
<ul>
<li><code>vision_learner</code>: Is a helper function from the fastai <code>Learner</code> class. It is used to conveniently create a learner object
<ul>
<li>Documentation: <a href="https://docs.fast.ai/vision.learner.html#vision_learner">vision.learner.html#vision_learner</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/21_vision.learner.ipynb">21_vision.learner.ipynb</a></li>
</ul></li>
<li><code>Learner</code>: Is a fastai class that combines data, model, and error function into a single pipeline.
<ul>
<li>Documentation: <a href="https://docs.fast.ai/learner.html#learner">learner.html#learner</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/21_vision.learner.ipynb">21_vision.learner.ipynb</a></li>
</ul></li>
<li><code>resnet18</code>: Is a Pytorch pre-trained model with ResNet-18 architecture for image recognition.
<ul>
<li>Documentation: <a href="https://pytorch.org/vision/stable/index.html">pytorch.org/vision</a></li>
</ul></li>
<li><code>error_rate</code>: Is a fastai metric function</li>
<li><code>Learner.fine_tune</code>: Is a <em>Learner</em> class function that trains a model
<ul>
<li>Documentation: <a href="https://docs.fast.ai/callback.schedule.html#learner.fine_tune">callback.schedule.html#learner.fine_tune</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/14_callback.schedule.ipynb">14_callback.schedule.ipynb</a></li>
</ul></li>
</ul>
<p><strong>Summary of the steps till now</strong></p>
<ul>
<li>Create an image classifier <code>Learner</code> object</li>
<li>Train a model using <code>Learner.fine_tune</code> method</li>
</ul>
</section>
<section id="interpret-the-trained-model" class="level1">
<h1>Interpret the trained model</h1>
<p>In the last section, we trained an image classifier that can distinguish between 4 different ball images: cricket, tennis, soccer, and basketball. But how good is our model? A confusion matrix is the best tool to interpret a model for classification problems. It visualizes and summarizes the performance of a classification algorithm. Let’s do it next.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Interpret the model using confusion matrix</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-49-output-5.png" class="img-fluid"></p>
</div>
</div>
<p>Again, we would like to know more about class <code>ClassificationInterpretation</code> as to which library it belongs. For this, let’s check the documentation.</p>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>?ClassificationInterpretation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>
ClassificationInterpretation<span class="ansi-blue-fg">(</span>
    learn<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'Learner'</span><span class="ansi-blue-fg">,</span>
    dl<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'DataLoader'</span><span class="ansi-blue-fg">,</span>
    losses<span class="ansi-blue-fg">:</span> <span class="ansi-blue-fg">'TensorBase'</span><span class="ansi-blue-fg">,</span>
    act<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Docstring:</span>      Interpretation methods for classification models.
<span class="ansi-red-fg">File:</span>           /opt/conda/lib/python3.8/site-packages/fastai/interpret.py
<span class="ansi-red-fg">Type:</span>           type
<span class="ansi-red-fg">Subclasses:</span>     
</pre>
</div>
</div>
</div>
<p>It tells us that this method is from the fastai interpret module. Its purpose is defined as “Interpretation methods for classification models”. We can check the module documentation <a href="https://docs.fast.ai/interpret.html#interpretation">interpret.html#interpretation</a> to get more details. There it says</p>
<blockquote class="blockquote">
<p><code>Interpretation</code> is a helper base class for exploring predictions from trained models. It can be inherited for task specific interpretation classes, such as <code>ClassificationInterpretation</code>. Interpretation is memory efficient and should be able to process any sized dataset, provided the hardware could train the same model.</p>
</blockquote>
<p>And to get an <code>Interpretation</code> object we are <code>Interpretation.from_learner</code> method. Its purpose is to “Construct interpretation object from a learner”. Read more about this method from docs <a href="https://docs.fast.ai/interpret.html#interpretation.from_learner">interpret.html#interpretation.from_learner</a></p>
<p>There are many useful functions in fastai <strong>Interpretation</strong> class, and I would encourage you to check them from the documentation. Once such method is <code>plot_top_losses</code>. Its purpose is “Show k largest(/smallest) preds and losses” from the validation set and plot the data points where our model has the high loss score. Usually, a model makes a wrong prediction when it has low confidence (or the model can be very confident in a wrong prediction). So this function can be valuable in understanding a model’s performance.</p>
<p>Let’s use this function next. You may read more about this function from docs <a href="https://docs.fast.ai/interpret.html#interpretation.plot_top_losses">interpret.html#interpretation.plot_top_losses</a></p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Plot top losses</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>, nrows<span class="op">=</span><span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-51-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Let’s analyze the results from the last cell. It outputs model performance as “Prediction/Actual/Loss/Confidence”</p>
<ul>
<li>Prediction: What label has our model predicted for a given image</li>
<li>Actual: What label does our validation data have for that image</li>
<li>Loss: A quantitative measure of how wrong was the model prediction. Making a wrong prediction with high confidence gets a high score</li>
<li>Confidence: The confidence/probability that the model thinks a given image has the predicted label</li>
</ul>
<p>Now let’s check the output images.</p>
<ul>
<li>First image gets the highest loss. Our model thinks (very confidently) that this image is a tennis ball. But in our validation set, it is a cricket ball with green color. This makes sense because our model has learned that green balls are tennis balls.</li>
<li>The second image model again thinks it is a tennis ball. It seems right as it looks like a tennis ball to the human eye. We can remove this image from validation if we are unsure about it.</li>
<li>In the third image, our model thinks it is a cricket ball though it is a soccer ball. What do we learn from this? Our model has not seen soccer ball images before that have green and red colors in it. So we may include more soccer ball images with that color.</li>
</ul>
<p>Similarly, we can analyze the remaining results and take action accordingly.</p>
</section>
<section id="export-and-load-a-trained-model" class="level1">
<h1>Export and load a trained model</h1>
<p>So we have trained our image classifier and are happy with the results. The next phase in ML work is to copy/transfer this artifact to a server where it can be hosted for inference work. Remember, a trained model consists of the architecture and the trained parameters. So to store a model, we need to save both these parts, and no information is lost. For this, we can use <code>Learner.export</code> method to keep the model in a <code>pickle</code> binary format.</p>
<ul>
<li>You can learn more about <em>Learner.export</em> from documentation <a href="https://docs.fast.ai/learner.html#learner.export">learner.html#learner.export</a></li>
<li>Source code: <a href="https://github.com/fastai/fastai/blob/master/nbs/13a_learner.ipynb">13a_learner.ipynb</a></li>
<li>To read about <code>pickle</code> Python object serialization module check the official docs <a href="https://docs.python.org/3/library/pickle.html">pickle.html</a></li>
</ul>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Define export file name and path</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>export_file <span class="op">=</span> local_path <span class="op">+</span> <span class="st">"/export_model.pkl"</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>export_file</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>'./datasets/2022-08-10-sagemaker-fastai-classifier/export_model.pkl'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Export the model</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>learn.export(export_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check the local directory contents if the model pickle file is present.</p>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Check local directory for .pkl file</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> Path(local_path)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>p.ls(file_exts<span class="op">=</span><span class="st">".pkl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>(#1) [Path('datasets/2022-08-10-sagemaker-fastai-classifier/export_model.pkl')]</code></pre>
</div>
</div>
<p>Now let’s load the exported model again using <code>load_learner</code> function. Read its docs <a href="https://docs.fast.ai/learner.html#load_learner">learner.html#load_learner</a></p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Load a model</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>learn_inf <span class="op">=</span> load_learner(export_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall that we downloaded a sample tennis ball image at the start of this notebook. Let’s use that to make a prediction on the loaded model.</p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Sample tennis ball image</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> Image.<span class="bu">open</span>(dest)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>im.to_thumb(<span class="dv">256</span>,<span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<p><img src="2022-08-10-sagemaker-fastai-classifier_files/figure-html/cell-56-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Make a prediction</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>learn_inf.predict(dest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>('tennis',
 TensorBase(3),
 TensorBase([1.0414e-05, 1.6653e-05, 2.1281e-06, 9.9997e-01]))</code></pre>
</div>
</div>
<p>It has returned three items:</p>
<ul>
<li>The predicted category in the format we provided the labels</li>
<li>The index of the predicted category “3”. Indexes start from 0</li>
<li>And the probabilities of each category</li>
</ul>
<p>If you want to get a list of all the categories, then you can access <code>DataLoaders</code> attribute of the <code>Learner</code>.</p>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">##</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step: Get a list of all categories from Learner</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>learn_inf.dls.vocab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>['basketball', 'cricket', 'soccer', 'tennis']</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="hassaanbinaslam/myblog_utterances" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>