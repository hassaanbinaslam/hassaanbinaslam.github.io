<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-04-11">
<meta name="keywords" content="docker, python, logs, aws, cloudwatch">
<meta name="description" content="A tutorial on sending docker application logs to aws cloudwatch.">

<title>Random Thoughts - Docker - Send Container Logs to AWS CloudWatch</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D1ST9BH6HX"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-D1ST9BH6HX', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Random Thoughts - Docker - Send Container Logs to AWS CloudWatch">
<meta property="og:description" content="A tutorial on sending docker application logs to aws cloudwatch.">
<meta property="og:image" content="images/2022-04-11-docker-logs-cloudwatch.jpg">
<meta property="og:site-name" content="Random Thoughts">
<meta name="twitter:title" content="Random Thoughts - Docker - Send Container Logs to AWS CloudWatch">
<meta name="twitter:description" content="A tutorial on sending docker application logs to aws cloudwatch.">
<meta name="twitter:image" content="images/2022-04-11-docker-logs-cloudwatch.jpg">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Random Thoughts</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hassaanbinaslam/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hassaanbinaslam/"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/hassaanbinaslam"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about" id="toc-about" class="nav-link active" data-scroll-target="#about">About</a></li>
  <li><a href="#environment-details" id="toc-environment-details" class="nav-link" data-scroll-target="#environment-details">Environment Details</a>
  <ul class="collapse">
  <li><a href="#sample-application" id="toc-sample-application" class="nav-link" data-scroll-target="#sample-application">Sample Application</a></li>
  </ul></li>
  <li><a href="#dockerize-the-application" id="toc-dockerize-the-application" class="nav-link" data-scroll-target="#dockerize-the-application">Dockerize the application</a>
  <ul class="collapse">
  <li><a href="#get-aws-credentials" id="toc-get-aws-credentials" class="nav-link" data-scroll-target="#get-aws-credentials">Get AWS Credentials</a>
  <ul class="collapse">
  <li><a href="#create-iam-policy" id="toc-create-iam-policy" class="nav-link" data-scroll-target="#create-iam-policy">Create IAM Policy</a></li>
  <li><a href="#create-iam-group-and-user" id="toc-create-iam-group-and-user" class="nav-link" data-scroll-target="#create-iam-group-and-user">Create IAM Group and User</a></li>
  </ul></li>
  <li><a href="#configure-aws-credentials-for-docker-daemon" id="toc-configure-aws-credentials-for-docker-daemon" class="nav-link" data-scroll-target="#configure-aws-credentials-for-docker-daemon">Configure AWS credentials for docker daemon</a></li>
  <li><a href="#run-docker-container-with-awslogs-driver" id="toc-run-docker-container-with-awslogs-driver" class="nav-link" data-scroll-target="#run-docker-container-with-awslogs-driver">Run docker container with awslogs driver</a></li>
  <li><a href="#verify-logs-from-cloudwatch" id="toc-verify-logs-from-cloudwatch" class="nav-link" data-scroll-target="#verify-logs-from-cloudwatch">Verify Logs from CloudWatch</a></li>
  <li><a href="#error-messages" id="toc-error-messages" class="nav-link" data-scroll-target="#error-messages">Error Messages</a>
  <ul class="collapse">
  <li><a href="#other-method-to-provide-aws-credentials-to-docker-daemon" id="toc-other-method-to-provide-aws-credentials-to-docker-daemon" class="nav-link" data-scroll-target="#other-method-to-provide-aws-credentials-to-docker-daemon">Other method to provide AWS credentials to docker daemon</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#important-references" id="toc-important-references" class="nav-link" data-scroll-target="#important-references">Important References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Docker - Send Container Logs to AWS CloudWatch</h1>
  <div class="quarto-categories">
    <div class="quarto-category">docker</div>
    <div class="quarto-category">python</div>
    <div class="quarto-category">aws</div>
    <div class="quarto-category">cloudwatch</div>
  </div>
  </div>

<div>
  <div class="description">
    A tutorial on sending docker application logs to aws cloudwatch.
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 11, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><img src="images/2022-04-11-docker-logs-cloudwatch.jpg" class="img-fluid"></p>
<section id="about" class="level1">
<h1>About</h1>
<p>This post is about configuring docker container to send application logs to <a href="https://aws.amazon.com/cloudwatch/details/#log-monitoring">Amazon CloudWatch</a>. Logs entries can be retrieved from AWS Management Console.</p>
</section>
<section id="environment-details" class="level1">
<h1>Environment Details</h1>
<ul>
<li>Python = 3.8.x</li>
<li>Docker version = 20.10.7</li>
<li>OS = Amazon Linux 2</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">iamadmin:~/environment</span> $ docker version</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ex">Client:</span></span>
<span id="cb1-3"><a href="#cb1-3"></a> <span class="ex">Version:</span>           20.10.7</span>
<span id="cb1-4"><a href="#cb1-4"></a> <span class="ex">API</span> version:       1.41</span>
<span id="cb1-5"><a href="#cb1-5"></a> <span class="ex">Go</span> version:        go1.15.14</span>
<span id="cb1-6"><a href="#cb1-6"></a> <span class="ex">Git</span> commit:        f0df350</span>
<span id="cb1-7"><a href="#cb1-7"></a> <span class="ex">Built:</span>             Wed Nov 17 03:05:36 2021</span>
<span id="cb1-8"><a href="#cb1-8"></a> <span class="ex">OS/Arch:</span>           linux/amd64</span>
<span id="cb1-9"><a href="#cb1-9"></a> <span class="ex">Context:</span>           default</span>
<span id="cb1-10"><a href="#cb1-10"></a> <span class="ex">Experimental:</span>      true</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="ex">Server:</span></span>
<span id="cb1-13"><a href="#cb1-13"></a> <span class="ex">Engine:</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="ex">Version:</span>          20.10.7</span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="ex">API</span> version:      1.41 <span class="er">(</span><span class="ex">minimum</span> version 1.12<span class="kw">)</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="ex">Go</span> version:       go1.15.14</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="ex">Git</span> commit:       b0f5bc3</span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="ex">Built:</span>            Wed Nov 17 03:06:14 2021</span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="ex">OS/Arch:</span>          linux/amd64</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="ex">Experimental:</span>     false</span>
<span id="cb1-21"><a href="#cb1-21"></a> <span class="ex">containerd:</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="ex">Version:</span>          1.4.6</span>
<span id="cb1-23"><a href="#cb1-23"></a>  <span class="ex">GitCommit:</span>        d71fcd7d8303cbf684402823e425e9dd2e99285d</span>
<span id="cb1-24"><a href="#cb1-24"></a> <span class="ex">runc:</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="ex">Version:</span>          1.0.0</span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="ex">GitCommit:</span>        84113eef6fc27af1b01b3181f31bbaf708715301</span>
<span id="cb1-27"><a href="#cb1-27"></a> <span class="ex">docker-init:</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="ex">Version:</span>          0.19.0</span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="ex">GitCommit:</span>        de40ad0</span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="ex">iamadmin:~/environment</span> $ cat /etc/os-release</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="va">NAME</span><span class="op">=</span><span class="st">"Amazon Linux"</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="va">VERSION</span><span class="op">=</span><span class="st">"2"</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="va">ID</span><span class="op">=</span><span class="st">"amzn"</span></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="va">ID_LIKE</span><span class="op">=</span><span class="st">"centos rhel fedora"</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="va">VERSION_ID</span><span class="op">=</span><span class="st">"2"</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="va">PRETTY_NAME</span><span class="op">=</span><span class="st">"Amazon Linux 2"</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="va">ANSI_COLOR</span><span class="op">=</span><span class="st">"0;33"</span></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="va">CPE_NAME</span><span class="op">=</span><span class="st">"cpe:2.3:o:amazon:amazon_linux:2"</span></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="va">HOME_URL</span><span class="op">=</span><span class="st">"https://amazonlinux.com/"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="sample-application" class="level2">
<h2 class="anchored" data-anchor-id="sample-application">Sample Application</h2>
<p>Let us create a simple hello world application that will print “hello world” message to stdout. After each message the application sleeps for 5 seconds, and keeps on doing this for 5 mins (300 sec). After this the program exists.</p>
<p>Project structure of this application is</p>
<pre><code>app/
└── src/
    └── hello.py</code></pre>
<p>Where * <code>app/</code> is the project root folder * <code>src/</code> folder contain the python application code * <code>src/hello.py</code> is the main application</p>
<p>Code files are provided below</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">##</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># app/src/hello.py</span></span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="im">import</span> time</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="kw">def</span> main():</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="co"># run for about 5 min: 300 sec</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">60</span>):</span>
<span id="cb3-11"><a href="#cb3-11"></a>        now <span class="op">=</span> datetime.now()</span>
<span id="cb3-12"><a href="#cb3-12"></a>        dt_string <span class="op">=</span> now.strftime(<span class="st">"</span><span class="sc">%d</span><span class="st">/%m/%Y %H:%M:%S"</span>)</span>
<span id="cb3-13"><a href="#cb3-13"></a></span>
<span id="cb3-14"><a href="#cb3-14"></a>        <span class="co"># prepare message</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>        msg <span class="op">=</span> <span class="ss">f"hello world at </span><span class="sc">{</span>dt_string<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a>        <span class="co"># put message to stdout and logs</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>        <span class="bu">print</span>(msg)</span>
<span id="cb3-19"><a href="#cb3-19"></a></span>
<span id="cb3-20"><a href="#cb3-20"></a>        <span class="co"># sleep for some seconds</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>        time.sleep(<span class="dv">5</span>)</span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb3-25"><a href="#cb3-25"></a>    main()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When I run the hello.py file I get the output on the termial with hello world messages like this.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/2022-04-11-docker-logs-cloudwatch/helloworld_output.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">helloworld_output</figcaption><p></p>
</figure>
</div>
</section>
</section>
<section id="dockerize-the-application" class="level1">
<h1>Dockerize the application</h1>
<p>Let’s put it inside a docker container. For this let’s create a <code>Dockerfile</code> and place it in <code>app/</code> folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">##</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># app/Dockerfile</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>FROM python:<span class="fl">3.8</span><span class="op">-</span>slim<span class="op">-</span>buster</span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># set the working directory in the container</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>WORKDIR <span class="op">/</span>app</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># copy the content of the local src directory to the working directory</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>COPY src<span class="op">/</span> .</span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co"># command to run on container start</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>CMD [ <span class="st">"python3"</span>, <span class="st">"-u"</span>, <span class="st">"./hello.py"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can build our docker image by running the command from terminal at folder <code>app/</code></p>
<pre><code>docker build --tag python-docker .</code></pre>
<p>Output of this command will look like this <img src="images/2022-04-11-docker-logs-cloudwatch/docker-build-cmd.png" class="img-fluid" alt="docker-build-cmd"></p>
<p>We can check the created docker image using command from terminal</p>
<pre><code>docker images</code></pre>
<p>Output of this command will look like this <img src="images/2022-04-11-docker-logs-cloudwatch/docker-image.png" class="img-fluid" alt="docker-images-cmd"></p>
<p>So our docker image is ready, we can now run it using command</p>
<pre><code>docker run python-docker</code></pre>
<p>After running this command you will see the application logs on the terminal. <img src="images/2022-04-11-docker-logs-cloudwatch/docker-run-output.png" class="img-fluid" alt="docker-images-cmd"></p>
<section id="get-aws-credentials" class="level2">
<h2 class="anchored" data-anchor-id="get-aws-credentials">Get AWS Credentials</h2>
<p>Now that we have our sample application and it’s docker container ready, we can work on pushing the docker logs to AWS CloudWatch. For this we need access credentials to AWS account where we want our logs to be available. We will create a separate account in AWS with CloudWatch access and use it’s credentials with docker daemon. Our steps will be * Create IAM policy with CloudWatch access * Create IAM group with that policy * Create IAM user and add that to this group</p>
<section id="create-iam-policy" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-policy">Create IAM Policy</h3>
<ul>
<li>From AWS Console go to IAM Console</li>
<li>Select Policies, and click ‘Create Policy’</li>
<li>From Create Policy window, select
<ul>
<li>Service = CloudWatch Logs</li>
<li>Actions = CreateLogStream, GetLogRecord, DescribeLogGroups, DescribeLogStreams, GetLogEvents, CreateLogGroup, PutLogEvents</li>
<li>Resources = All</li>
</ul></li>
</ul>
<p>After giving required permissions, policy summary will be like</p>
<pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DockerContainerLogs",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream",
                "logs:GetLogRecord",
                "logs:DescribeLogGroups",
                "logs:DescribeLogStreams",
                "logs:GetLogEvents",
                "logs:CreateLogGroup",
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}</code></pre>
</section>
<section id="create-iam-group-and-user" class="level3">
<h3 class="anchored" data-anchor-id="create-iam-group-and-user">Create IAM Group and User</h3>
<ul>
<li>From IAM console create a new IAM group and give it some appropriate name ‘docker-logs-group’</li>
<li>Attach the above created policy to that group</li>
<li>From the console create a new IAM user with “Access key - Programmatic access”. Give it some appropriate name ‘docker-logs-user’</li>
<li>Store <strong>access key ID</strong> and <strong>secret access key</strong></li>
<li>Add the user to the group created in last step</li>
</ul>
</section>
</section>
<section id="configure-aws-credentials-for-docker-daemon" class="level2">
<h2 class="anchored" data-anchor-id="configure-aws-credentials-for-docker-daemon">Configure AWS credentials for docker daemon</h2>
<p>To configure docker daemon to use AWS access credentials, execute command from the terminal <code>sudo systemctl edit docker</code>. A new window will open for text to edit, and add the following lines to it. Replace <code>my-aws-access-key</code> and <code>my-secret-access-key</code> with your access keys.</p>
<pre><code>[Service]
Environment="AWS_ACCESS_KEY_ID=my-aws-access-key"
Environment="AWS_SECRET_ACCESS_KEY=my-secret-access-key"</code></pre>
<p>This command will update the credentials in file <code>/etc/systemd/system/docker.service.d/override.conf</code>. Verify it using command</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">$</span> cat /etc/systemd/system/docker.service.d/override.conf</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">[Service]</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="va">Environment</span><span class="op">=</span><span class="st">"AWS_ACCESS_KEY_ID=AKIA3VIXXJNKPUSIOR3Y"</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="va">Environment</span><span class="op">=</span><span class="st">"AWS_SECRET_ACCESS_KEY=XhjlKVkZm1XdXedjgBcfLVM3FBU6zkGU"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After making changes to Docker daemon we need to restart it. For this * Flush the change with command <code>sudo systemctl daemon-reload</code> * Restart the docker daemon with command <code>sudo systemctl restart docker</code></p>
</section>
<section id="run-docker-container-with-awslogs-driver" class="level2">
<h2 class="anchored" data-anchor-id="run-docker-container-with-awslogs-driver">Run docker container with awslogs driver</h2>
<p>We can now run the docker image with <code>awslogs</code> driver using command</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="ex">docker</span> run <span class="dt">\</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>--log-driver=awslogs <span class="dt">\</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>--log-opt awslogs-region=us-east-1 <span class="dt">\</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>--log-opt awslogs-group=myLogGroup <span class="dt">\</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>--log-opt awslogs-create-group=true <span class="dt">\</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>python-docker</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><code>log-driver</code> configures the driver to be used for logs. Default driver is ‘json-file’ and <code>awslogs</code> is for CloudWatch</li>
<li><code>awslogs-region</code> specifies the region for AWS CloudWatch logs</li>
<li><code>awslogs-group</code> specifies the log group for CloudWatch</li>
<li><code>awslogs-create-group</code> specifes that if provided log group does not exists on CloudWatch then create one</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/2022-04-11-docker-logs-cloudwatch/docker-run-awslogs.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">docker-images-cmd</figcaption><p></p>
</figure>
</div>
</section>
<section id="verify-logs-from-cloudwatch" class="level2">
<h2 class="anchored" data-anchor-id="verify-logs-from-cloudwatch">Verify Logs from CloudWatch</h2>
<p>Go to CloudWatch console and select <code>Log Groups</code> and then <code>myLogGroup</code>. You will find the logs generated by docker container.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/2022-04-11-docker-logs-cloudwatch/cloudwatch-logs.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">docker-images-cmd</figcaption><p></p>
</figure>
</div>
<p>All the code used for this post can be obtained from the GitHub repository <a href="https://github.com/hassaanbinaslam/2022-04-11-docker-logs-cloudwatch">hassaanbinaslam/2022-04-11-docker-logs-cloudwatch</a></p>
<ul>
<li><a href="https://github.com/hassaanbinaslam/2022-04-11-docker-logs-cloudwatch/tree/fd1e272bf35026a1de1e95064d454214ce982fdb">Project code files</a></li>
<li><a href="https://github.com/hassaanbinaslam/2022-04-11-docker-logs-cloudwatch/releases/tag/snapshot-01">Project zip file</a></li>
</ul>
</section>
<section id="error-messages" class="level2">
<h2 class="anchored" data-anchor-id="error-messages">Error Messages</h2>
<p>If docker daemon is not able to find AWS credentails then it will generate an error message similar to pasted below</p>
<pre><code>docker: Error response from daemon: failed to initialize logging driver: failed to create Cloudwatch log stream: NoCredentialProviders: no valid providers in chain. Deprecated.
        For verbose messaging see aws.Config.CredentialsChainVerboseErrors.</code></pre>
<p>If you get this message then you need to recheck the credentails passed to docker daemon.</p>
<p>One thing I noticed is that on Windows there is no way to pass AWS credentials to docker daemon. People have reported similar issues with docker running on MAC OS. Refer to below link for this discussion</p>
<ul>
<li>https://github.com/docker/for-win/issues/9684</li>
</ul>
<section id="other-method-to-provide-aws-credentials-to-docker-daemon" class="level3">
<h3 class="anchored" data-anchor-id="other-method-to-provide-aws-credentials-to-docker-daemon">Other method to provide AWS credentials to docker daemon</h3>
<p><a href="https://docs.docker.com/config/containers/logging/awslogs/#credentials">Docker documentation</a> mentions that AWS credentails can also be set * By configuring the environment variables <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>. I have tried this approach but docker daemon is not able to pick AWS credentials from environment variables * By using AWS credentials file <code>~/.aws/credentials</code>. I have also tried this approach and it does not work either</p>
</section>
</section>
</section>
<section id="important-references" class="level1">
<h1>Important References</h1>
<ul>
<li><a href="https://docs.docker.com/config/containers/logging/configure/">Docker configuring logging drivers</a></li>
<li><a href="https://docs.docker.com/config/containers/logging/awslogs/">Amazon CloudWatch Logs logging driver</a></li>
<li>https://transang.me/configure-docker-to-send-log-to-aws/</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="hassaanbinaslam/myblog_utterances" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>